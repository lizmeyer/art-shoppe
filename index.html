<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Cozy Artist Shop</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" href="assets/images/ui/favicon.png">
    <link rel="apple-touch-icon" href="assets/images/ui/app-icon.png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
</head>
<body data-theme="pastel">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="screen loading-screen">
        <div class="loading-content">
            <img src="assets/images/ui/shop-icon.png" alt="Shop Icon" class="loading-icon bounce-animation">
            <h2>Opening Your Art Shop...</h2>
            <div class="progress-container">
                <div id="loadingBar" class="progress-bar"></div>
            </div>
        </div>
    </div>
    
    <!-- Error Screen -->
    <div id="errorScreen" class="screen error-screen hidden">
        <div class="error-content">
            <h2>Startup Error</h2>
            <p>There was a problem starting the game:</p>
            <div id="errorMessage" class="error-message"></div>
            <p>Try refreshing the page. If the problem persists, check the console for more details.</p>
            <button id="retryButton" class="button accent-button">Refresh Page</button>
        </div>
    </div>
    
    <!-- Tutorial Overlay -->
    <div id="tutorialOverlay" class="overlay tutorial-overlay hidden">
        <div class="tutorial-container">
            <h3 id="tutorialTitle">Welcome to Your Shop!</h3>
            <div id="tutorialContent" class="tutorial-content">
                <!-- Tutorial content will be inserted here -->
            </div>
            <div class="tutorial-nav">
                <button id="tutorialPrevButton" class="button secondary-button hidden">Previous</button>
                <span id="tutorialProgress">1/6</span>
                <button id="tutorialNextButton" class="button accent-button">Next</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="notification" class="notification hidden"></div>
    
    <!-- Main Game Container -->
    <div id="gameContainer" class="game-container hidden">
        <!-- Header -->
        <header class="game-header">
            <div class="currency-display">
                <img src="assets/images/ui/coin.png" alt="Coins" class="currency-icon">
                <span id="coinDisplay">100</span>
            </div>
            <div class="day-display">
                Day <span id="dayDisplay">1</span>
            </div>
            <button id="menuButton" class="menu-button" aria-label="Menu">☰</button>
        </header>
        
        <!-- Main Content Area -->
        <main class="game-content">
            <!-- Shop View -->
            <section id="shopView" class="game-view">
                <div class="shop-background"></div>
                <h2 class="view-title">Your Shop</h2>
                
                <div class="shop-displays-container">
                    <h3>Product Displays</h3>
                    <p class="hint-text">Drag products from your inventory to these displays</p>
                    <div id="shopDisplays" class="shop-displays"></div>
                </div>
                
                <div class="customer-section">
                    <h3>Customers</h3>
                    <div id="customerArea" class="customer-area"></div>
                </div>
            </section>
            
            <!-- Studio View -->
            <section id="studioView" class="game-view hidden">
                <h2 class="view-title">Art Studio</h2>
                
                <div class="product-selection">
                    <label for="productSelector">Select Product:</label>
                    <select id="productSelector"></select>
                </div>
                
                <div class="canvas-container">
                    <div id="productPreview" class="product-preview"></div>
                    <canvas id="artCanvas" width="300" height="300"></canvas>
                </div>
                
                <div class="art-tools">
                    <div class="tool-section">
                        <h3>Colors</h3>
                        <div id="colorPalette" class="color-palette"></div>
                    </div>
                    
                    <div class="tool-section">
                        <h3>Brush Size</h3>
                        <input type="range" id="brushSize" min="1" max="20" value="5">
                    </div>
                    
                    <div class="canvas-actions">
                        <button id="clearArtButton" class="button secondary-button">Clear</button>
                        <button id="saveArtButton" class="button accent-button">Create Product</button>
                    </div>
                </div>
            </section>
            
            <!-- Inventory View -->
            <section id="inventoryView" class="game-view hidden">
                <h2 class="view-title">Inventory</h2>
                <p class="hint-text">Drag items to your shop displays to sell them</p>
                <div id="inventoryItems" class="inventory-grid"></div>
            </section>
            
            <!-- Settings View -->
            <section id="settingsView" class="game-view hidden">
                <h2 class="view-title">Settings</h2>
                
                <div class="settings-group">
                    <h3>Theme</h3>
                    <div class="theme-options">
                        <button data-theme="pastel" class="theme-button active">Pastel</button>
                        <button data-theme="mint" class="theme-button">Mint</button>
                        <button data-theme="lavender" class="theme-button">Lavender</button>
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3>Audio</h3>
                    <div class="settings-row">
                        <label for="musicVolume">Music</label>
                        <input type="range" id="musicVolume" min="0" max="100" value="50">
                    </div>
                    <div class="settings-row">
                        <label for="sfxVolume">Sound Effects</label>
                        <input type="range" id="sfxVolume" min="0" max="100" value="70">
                    </div>
                </div>
                
                <div class="settings-group">
                    <h3>Game</h3>
                    <button id="saveGameButton" class="button accent-button">Save Game</button>
                    <button id="resetGameButton" class="button danger-button">Reset Game</button>
                    <button id="showTutorialButton" class="button secondary-button">Show Tutorial</button>
                </div>
                
                <div class="settings-group">
                    <h3>About</h3>
                    <p>Cozy Artist Shop v1.0</p>
                    <p>A game where you create art, sell products, and manage your shop.</p>
                </div>
            </section>
        </main>
        
        <!-- Action Bar -->
        <div id="actionBar" class="action-bar">
            <button id="nextDayButton" class="action-button accent-button">Next Day</button>
        </div>
        
        <!-- Navigation -->
        <nav class="game-nav">
            <button data-view="shopView" class="nav-button active">Shop</button>
            <button data-view="studioView" class="nav-button">Studio</button>
            <button data-view="inventoryView" class="nav-button">Inventory</button>
            <button data-view="settingsView" class="nav-button">Settings</button>
        </nav>
    </div>
    
    <!-- Modal Containers (will be populated dynamically) -->
    <div id="modalContainer"></div>
    
    <!-- JavaScript -->
    <script src="js/utils.js"></script>
    <script src="js/gameState.js"></script>
    <script src="js/canvas.js"></script>
    <script src="js/customers.js"></script>
    <script>
/**
 * Emergency gameState implementation
 * This creates a minimal gameState object with essential functionality
 */
console.log('Creating emergency gameState object');

// Create minimal gameState
window.gameState = {
  // Core data
  data: {
    coins: 100,
    day: 1,
    inventory: [],
    shopDisplays: [],
    activeCustomers: [],
    settings: {
      theme: 'pastel',
      musicVolume: 50,
      sfxVolume: 70,
      tutorialComplete: false
    }
  },
  
  // Initialize basic game state
  init() {
    console.log('Initializing minimal gameState');
    
    // Create shop displays if empty
    if (!this.data.shopDisplays.length) {
      this.initializeShopDisplays();
    }
    
    // Load saved data if available
    this.loadGame();
    
    return true;
  },
  
  // Initialize shop displays
  initializeShopDisplays() {
    console.log('Creating shop displays');
    this.data.shopDisplays = Array(6).fill(null).map((_, i) => ({
      id: `display-${i}`,
      productId: null,
      filled: false
    }));
  },
  
  // Save game to localStorage
  saveGame() {
    try {
      localStorage.setItem('cozyArtistShop', JSON.stringify(this.data));
      return true;
    } catch (error) {
      console.error('Failed to save game:', error);
      return false;
    }
  },
  
  // Load game from localStorage
  loadGame() {
    try {
      const savedData = localStorage.getItem('cozyArtistShop');
      if (savedData) {
        const parsed = JSON.parse(savedData);
        Object.keys(parsed).forEach(key => {
          if (this.data.hasOwnProperty(key)) {
            this.data[key] = parsed[key];
          }
        });
      }
      return true;
    } catch (error) {
      console.error('Failed to load game:', error);
      return false;
    }
  },
  
  // Display a product in the shop
  displayProduct(productId, displayId) {
    try {
      // Find product in inventory
      const productIndex = this.data.inventory.findIndex(p => p.id === productId);
      if (productIndex === -1) return false;
      
      // Find display
      const displayIndex = this.data.shopDisplays.findIndex(d => d.id === displayId);
      if (displayIndex === -1) return false;
      
      // Update display
      this.data.shopDisplays[displayIndex].productId = productId;
      this.data.shopDisplays[displayIndex].filled = true;
      
      // Mark product as displayed
      this.data.inventory[productIndex].displayed = true;
      
      return true;
    } catch (error) {
      console.error('Error displaying product:', error);
      return false;
    }
  },
  
  // Remove from display
  removeFromDisplay(displayId) {
    try {
      // Find display
      const displayIndex = this.data.shopDisplays.findIndex(d => d.id === displayId);
      if (displayIndex === -1) return false;
      
      // Get product ID
      const productId = this.data.shopDisplays[displayIndex].productId;
      
      // Reset display
      this.data.shopDisplays[displayIndex].productId = null;
      this.data.shopDisplays[displayIndex].filled = false;
      
      // Update product in inventory
      if (productId) {
        const productIndex = this.data.inventory.findIndex(p => p.id === productId);
        if (productIndex !== -1) {
          this.data.inventory[productIndex].displayed = false;
        }
      }
      
      return true;
    } catch (error) {
      console.error('Error removing from display:', error);
      return false;
    }
  },
  
  // Sell a product
  sellProduct(productId, price) {
    try {
      // Find product
      const productIndex = this.data.inventory.findIndex(p => p.id === productId);
      if (productIndex === -1) return false;
      
      // Check if product is on display
      const displayIndex = this.data.shopDisplays.findIndex(d => d.productId === productId);
      
      // Remove from display if displayed
      if (displayIndex !== -1) {
        this.data.shopDisplays[displayIndex].productId = null;
        this.data.shopDisplays[displayIndex].filled = false;
      }
      
      // Add coins
      this.data.coins += price;
      
      // Remove from inventory
      this.data.inventory.splice(productIndex, 1);
      
      return true;
    } catch (error) {
      console.error('Error selling product:', error);
      return false;
    }
  },
  
  // Start new day
  startNewDay() {
    try {
      this.data.day += 1;
      
      // Clear active customers
      this.data.activeCustomers = [];
      
      return this.data.day;
    } catch (error) {
      console.error('Error starting new day:', error);
      return this.data.day;
    }
  },
  
  // Get product template
  getProductTemplate(templateId) {
    const templates = {
      'mug': { 
        id: 'mug',
        name: 'Mug', 
        basePrice: 8,
        image: 'assets/images/products/mug.png',
        artPosition: { x: 70, y: 70, width: 120, height: 120, rotation: 0 }
      },
      'tote': { 
        id: 'tote',
        name: 'Tote Bag', 
        basePrice: 12,
        image: 'assets/images/products/tote.png',
        artPosition: { x: 60, y: 50, width: 140, height: 140, rotation: 0 }
      },
      'shirt': { 
        id: 'shirt',
        name: 'T-Shirt', 
        basePrice: 15,
        image: 'assets/images/products/tshirt.png',
        artPosition: { x: 75, y: 60, width: 110, height: 110, rotation: 0 }
      },
      'poster': { 
        id: 'poster',
        name: 'Poster', 
        basePrice: 10,
        image: 'assets/images/products/poster.png',
        artPosition: { x: 40, y: 40, width: 180, height: 180, rotation: 0 }
      }
    };
    
    return templates[templateId] || templates['mug'];
  },
  
  // Get displayed products
  getDisplayedProducts() {
    return this.data.shopDisplays
      .filter(display => display.filled)
      .map(display => {
        const product = this.data.inventory.find(p => p.id === display.productId);
        return {
          displayId: display.id,
          product: product
        };
      });
  }
};

// Product and customer data
window.ProductData = {
  templates: [
    { id: 'mug', name: 'Mug', basePrice: 8, image: 'assets/images/products/mug.png' },
    { id: 'tote', name: 'Tote Bag', basePrice: 12, image: 'assets/images/products/tote.png' },
    { id: 'shirt', name: 'T-Shirt', basePrice: 15, image: 'assets/images/products/tshirt.png' },
    { id: 'poster', name: 'Poster', basePrice: 10, image: 'assets/images/products/poster.png' }
  ],
  colorPalette: [
    '#FF5252', '#FF9800', '#FFEB3B', '#4CAF50', '#2196F3', 
    '#9C27B0', '#F06292', '#795548', '#607D8B', '#000000', '#FFFFFF'
  ]
};

window.CustomerData = {
  types: [
    {
      type: 'trendy',
      avatar: 'assets/images/customers/trendy.png',
      preferences: { products: ['tote', 'shirt'] },
      budget: { min: 15, max: 25 },
      patience: 15
    },
    {
      type: 'artsy',
      avatar: 'assets/images/customers/artsy.png',
      preferences: { products: ['poster', 'mug'] },
      budget: { min: 10, max: 20 },
      patience: 20
    },
    {
      type: 'casual',
      avatar: 'assets/images/customers/casual.png',
      preferences: { products: ['mug', 'tote', 'shirt', 'poster'] },
      budget: { min: 8, max: 18 },
      patience: 12
    }
  ]
};

// Initialize immediately to ensure it's ready
gameState.init();
console.log('Emergency gameState initialized successfully');
</script>
    
    <script src="js/ui.js"></script>
    <script src="js/main.js"></script>
    <script>
  // Debugging script for Create Product button
  document.addEventListener('DOMContentLoaded', function() {
    // 1. Log all buttons on the page to see if we can find your create button
    console.log('All buttons on page:', document.querySelectorAll('button'));
    
    // 2. Try to find the Create Product button by text content
    const createButtons = Array.from(document.querySelectorAll('button'))
      .filter(button => button.textContent.includes('Create Product'));
    console.log('Found Create Product buttons:', createButtons);
    
    // 3. Check if Canvas object exists
    console.log('Canvas object exists:', typeof Canvas !== 'undefined');
    
    // 4. Check if saveArtwork method exists
    console.log('Canvas.saveArtwork exists:', typeof Canvas !== 'undefined' && typeof Canvas.saveArtwork === 'function');
    
    // 5. Look for existing click handler
    if (createButtons.length > 0) {
      const createButton = createButtons[0];
      console.log('Button ID:', createButton.id);
      
      // 6. Add our own click handler
      createButton.addEventListener('click', function(e) {
        console.log('Create Product button clicked');
        
        // 7. Try to call saveArtwork directly
        try {
          if (typeof Canvas !== 'undefined' && typeof Canvas.saveArtwork === 'function') {
            console.log('Calling Canvas.saveArtwork()');
            Canvas.saveArtwork();
          } else {
            console.error('Canvas.saveArtwork function not found');
          }
        } catch (error) {
          console.error('Error calling saveArtwork:', error);
        }
      });
    }
  });
</script>

    <script>
  // Helper function to add event listeners to dynamic dialog buttons
  function setupProductDialogButtons() {
    // Add event listener for dynamically created dialog buttons
    document.addEventListener('click', function(event) {
      // Check for Add to Inventory button
      if (event.target.textContent === 'Add to Inventory') {
        console.log('Add to Inventory clicked');
        
        // Find the product ID from the dialog
        const productId = getProductIdFromDialog();
        if (productId) {
          // Add to inventory and close dialog
          if (typeof gameState !== 'undefined' && 
              typeof gameState.data !== 'undefined' && 
              Array.isArray(gameState.data.inventory)) {
            
            // Find the newly created product
            const product = getCurrentProductFromDialog();
            if (product) {
              gameState.data.inventory.push(product);
              console.log('Added to inventory:', product);
              
              // Show confirmation
              alert('Product added to inventory!');
              
              // Close the dialog
              closeProductDialog();
              
              // Update inventory view if needed
              if (typeof UI !== 'undefined' && typeof UI.renderInventory === 'function') {
                UI.renderInventory();
              }
            }
          } else {
            console.error('gameState.data.inventory is not available');
          }
        }
      }
      
      // Check for Add to Shop button
      if (event.target.textContent === 'Add to Shop') {
        console.log('Add to Shop clicked');
        
        // Find the product ID from the dialog
        const productId = getProductIdFromDialog();
        if (productId) {
          // Find available display spot
          const availableSpot = findAvailableDisplaySpot();
          if (availableSpot) {
            // Display the product
            if (typeof gameState !== 'undefined' && 
                typeof gameState.displayProduct === 'function') {
              
              // Add to inventory first
              const product = getCurrentProductFromDialog();
              if (product) {
                // Add to inventory
                gameState.data.inventory.push(product);
                
                // Then display it
                gameState.displayProduct(product.id, availableSpot.id);
                console.log('Added to shop display:', product, 'at spot:', availableSpot.id);
                
                // Show confirmation
                alert('Product added to shop display!');
                
                // Close the dialog
                closeProductDialog();
                
                // Update views
                if (typeof UI !== 'undefined') {
                  if (typeof UI.renderShopDisplays === 'function') {
                    UI.renderShopDisplays();
                  }
                  if (typeof UI.renderInventory === 'function') {
                    UI.renderInventory();
                  }
                }
              }
            } else {
              console.error('gameState.displayProduct function not available');
            }
          } else {
            alert('No available display spots! Remove an item first.');
            closeProductDialog();
          }
        }
      }
    });
  }
  
  // Helper to find product ID from the current dialog
  function getProductIdFromDialog() {
    return 'product-' + Date.now();
  }
  
  // Helper to get the current product data from dialog
  function getCurrentProductFromDialog() {
    // Get image from dialog
    const dialogImage = document.querySelector('.product-preview img.product-art-image');
    const artUrl = dialogImage ? dialogImage.src : '';
    
    // Determine product type (mug, tshirt, etc.)
    let templateId = 'mug'; // Default
    let productName = 'Custom Product';
    const productTitle = document.querySelector('.product-preview h4, .modal-header h3');
    if (productTitle) {
      const title = productTitle.textContent.toLowerCase();
      if (title.includes('mug')) {
        templateId = 'mug';
        productName = 'Mug with Custom Art';
      } else if (title.includes('tote')) {
        templateId = 'tote';
        productName = 'Tote Bag with Custom Art';
      } else if (title.includes('shirt')) {
        templateId = 'shirt';
        productName = 'T-Shirt with Custom Art';
      } else if (title.includes('poster')) {
        templateId = 'poster';
        productName = 'Poster with Custom Art';
      }
    }
    
    // Create product object
    return {
      id: getProductIdFromDialog(),
      templateId: templateId,
      name: productName,
      price: 12 + Math.floor(Math.random() * 8), // Random price between 12-19
      imageUrl: 'assets/images/products/' + templateId + '.png',
      artUrl: artUrl,
      created: new Date().toISOString(),
      displayed: false
    };
  }
  
  // Helper to find an available display spot
  function findAvailableDisplaySpot() {
    if (typeof gameState !== 'undefined' && 
        typeof gameState.data !== 'undefined' && 
        Array.isArray(gameState.data.shopDisplays)) {
      
      return gameState.data.shopDisplays.find(spot => !spot.filled);
    }
    return null;
  }
  
  // Helper to close the product dialog
  function closeProductDialog() {
    const dialog = document.querySelector('.modal, .product-preview-modal');
    if (dialog) {
      if (dialog.parentNode) {
        dialog.parentNode.removeChild(dialog);
      } else {
        dialog.style.display = 'none';
      }
    }
  }
  
  // Setup the buttons when document is loaded
  document.addEventListener('DOMContentLoaded', function() {
    setupProductDialogButtons();
    
    // Find Create Product button using Array.from and filter
    const createButtons = Array.from(document.querySelectorAll('button'))
      .filter(button => button.textContent.trim() === 'Create Product');
    
    if (createButtons.length > 0) {
      createButtons[0].addEventListener('click', function() {
        console.log('Create Product button clicked');
      });
    }
  });

  // Handle clicks on the Create Product button
  document.addEventListener('click', function(e) {
    if (e.target.textContent.trim() === 'Create Product') {
      console.log('Create Product clicked via delegation');
    }
  });
</script>

<script>
  // Wait for page to load
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Installing modal button handlers');
    
    // Check every 100ms for new modals
    setInterval(checkForModals, 100);
    
    // When a product is created, this modal will appear
    function checkForModals() {
      // Look for the product modal
      const modal = document.querySelector('.modal, [role="dialog"]');
      if (!modal) return;
      
      // Check if we've already processed this modal
      if (modal.getAttribute('data-processed')) return;
      
      console.log('Found new product modal, adding button handlers');
      modal.setAttribute('data-processed', 'true');
      
      // Find the buttons
      const buttons = modal.querySelectorAll('button');
      buttons.forEach(button => {
        // Remove any existing click handlers to prevent conflicts
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        // Get button text
        const buttonText = newButton.textContent.trim();
        console.log('Found button:', buttonText);
        
        // Add new click handler
        newButton.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Button clicked:', buttonText);
          
          if (buttonText === 'Add to Inventory' || buttonText === 'Add to inventory') {
            handleAddToInventory(modal);
          } else if (buttonText === 'Add to Shop' || buttonText === 'Shop') {
            handleAddToShop(modal);
          } else if (buttonText === '×' || buttonText === 'Close') {
            closeModal(modal);
          }
          
          return false;
        });
      });
    }
    
    // Handle Add to Inventory button
    function handleAddToInventory(modal) {
      console.log('Adding to inventory');
      
      // Create a product object
      const product = createProductObject();
      console.log('Created product:', product);
      
      // Add to inventory
      if (window.gameState && window.gameState.data && Array.isArray(window.gameState.data.inventory)) {
        window.gameState.data.inventory.push(product);
        console.log('Product added to inventory');
        
        // Save game state
        if (typeof window.gameState.saveGame === 'function') {
          window.gameState.saveGame();
        }
        
        // Update inventory UI
        if (window.UI && typeof window.UI.renderInventory === 'function') {
          window.UI.renderInventory();
        }
        
        // Show confirmation
        alert('Product added to inventory!');
      } else {
        // Fallback if gameState isn't available
        alert('Product created! (Debug: gameState not found)');
        console.error('gameState not found or inventory is not an array', window.gameState);
      }
      
      // Close the modal
      closeModal(modal);
    }
    
    // Handle Add to Shop button
    function handleAddToShop(modal) {
      console.log('Adding to shop');
      
      // Create a product object
      const product = createProductObject();
      console.log('Created product:', product);
      
      // Add to inventory first
      if (window.gameState && window.gameState.data && Array.isArray(window.gameState.data.inventory)) {
        window.gameState.data.inventory.push(product);
        console.log('Product added to inventory');
        
        // Find an empty display spot
        const emptySpot = findEmptyDisplaySpot();
        if (emptySpot) {
          console.log('Found empty display spot:', emptySpot);
          
          // Display the product
          if (typeof window.gameState.displayProduct === 'function') {
            window.gameState.displayProduct(product.id, emptySpot.id);
            console.log('Product displayed in shop');
            
            // Save game state
            if (typeof window.gameState.saveGame === 'function') {
              window.gameState.saveGame();
            }
            
            // Update UIs
            updateAllUI();
            
            // Show confirmation
            alert('Product added to shop!');
          } else {
            console.error('gameState.displayProduct function not found');
            alert('Could not display product in shop (function not found)');
          }
        } else {
          alert('No empty display spots available! Remove something first.');
          console.error('No empty display spots found');
        }
      } else {
        // Fallback if gameState isn't available
        alert('Product created! (Debug: gameState not found)');
        console.error('gameState not found or inventory is not an array', window.gameState);
      }
      
      // Close the modal
      closeModal(modal);
    }
    
    // Helper function to create a product object
    function createProductObject() {
      // Generate a product ID
      const productId = 'product-' + Date.now();
      
      // Get the product image from the modal
      const productImg = document.querySelector('.modal img, [role="dialog"] img');
      const productType = productImg ? (productImg.src.includes('mug') ? 'mug' : 'tote') : 'mug';
      
      // Get the art image (canvas data)
      const artImg = document.querySelector('.product-art-image, .modal img:nth-child(2)');
      const artUrl = artImg ? artImg.src : '';
      
      // Create a product object
      return {
        id: productId,
        templateId: productType,
        name: productType.charAt(0).toUpperCase() + productType.slice(1) + ' with Custom Art',
        price: 10 + Math.floor(Math.random() * 10), // Random price between 10-19
        imageUrl: 'assets/images/products/' + productType + '.png',
        artUrl: artUrl,
        created: new Date().toISOString(),
        displayed: false
      };
    }
    
    // Helper function to find an empty display spot
    function findEmptyDisplaySpot() {
      if (window.gameState && window.gameState.data && Array.isArray(window.gameState.data.shopDisplays)) {
        return window.gameState.data.shopDisplays.find(spot => !spot.filled);
      }
      return null;
    }
    
    // Helper function to close a modal
    function closeModal(modal) {
      if (modal) {
        try {
          // Try to remove from DOM
          if (modal.parentNode) {
            modal.parentNode.removeChild(modal);
          }
        } catch (e) {
          // If that fails, just hide it
          modal.style.display = 'none';
        }
      }
    }
    
    // Helper function to update all UI components
    function updateAllUI() {
      if (window.UI) {
        if (typeof window.UI.renderShopDisplays === 'function') {
          window.UI.renderShopDisplays();
        }
        if (typeof window.UI.renderInventory === 'function') {
          window.UI.renderInventory();
        }
        if (typeof window.UI.updateAllUI === 'function') {
          window.UI.updateAllUI();
        }
      }
    }
    
    // Direct fix for the Create Product button
    const createButtons = Array.from(document.querySelectorAll('button'))
      .filter(button => button.textContent.trim() === 'Create Product');
    
    if (createButtons.length > 0) {
      console.log('Found Create Product button');
      
      // Force Canvas.saveArtwork to work
      if (typeof window.Canvas === 'undefined' || typeof window.Canvas.saveArtwork !== 'function') {
        console.log('Adding fallback Canvas.saveArtwork function');
        window.Canvas = window.Canvas || {};
        window.Canvas.saveArtwork = function() {
          alert('Creating product...');
          // Implementation would go here, but we'll rely on the existing code
        };
      }
    }
  });
</script>

<script>
  // Fallback initialization in case DOMContentLoaded already fired
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(() => {
      if (typeof CanvasPainter !== 'undefined') {
        CanvasPainter.init();
      }
    }, 1000);
  }
</script>
    
<script>
// Minimal Canvas Drawing Implementation
document.addEventListener('DOMContentLoaded', function() {
  console.log('Setting up drawing functionality');
  
  // Find canvas element
  const canvas = document.querySelector('canvas');
  if (!canvas) {
    console.warn('Canvas element not found');
    return;
  }
  
  try {
    // Initialize canvas
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Set up variables
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let currentColor = '#000000';
    let brushSize = 5;
    
    // Set up event listeners
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch support
    canvas.addEventListener('touchstart', function(e) {
      e.preventDefault();
      const touch = e.touches[0];
      startDrawing({
        clientX: touch.clientX,
        clientY: touch.clientY
      });
    });
    
    canvas.addEventListener('touchmove', function(e) {
      e.preventDefault();
      const touch = e.touches[0];
      draw({
        clientX: touch.clientX,
        clientY: touch.clientY
      });
    });
    
    canvas.addEventListener('touchend', stopDrawing);
    
    // Drawing functions
    function startDrawing(e) {
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      lastX = e.clientX - rect.left;
      lastY = e.clientY - rect.top;
    }
    
    function draw(e) {
      if (!isDrawing) return;
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      ctx.beginPath();
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = brushSize;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      
      lastX = x;
      lastY = y;
    }
    
    function stopDrawing() {
      isDrawing = false;
    }
    
    // Set up color swatches
    const colorElements = document.querySelectorAll('.color-swatch');
    colorElements.forEach(element => {
      element.addEventListener('click', function() {
        const bgColor = window.getComputedStyle(this).backgroundColor;
        currentColor = bgColor;
        
        // Update selected state
        colorElements.forEach(el => el.classList.remove('selected'));
        this.classList.add('selected');
      });
    });
    
    // Set up brush size slider
    const brushSlider = document.querySelector('input[type="range"]');
    if (brushSlider) {
      brushSlider.addEventListener('input', function() {
        brushSize = parseInt(this.value);
      });
    }
    
    // Set up clear button
    const clearButton = Array.from(document.querySelectorAll('button'))
      .find(btn => btn.textContent.trim() === 'Clear');
    if (clearButton) {
      clearButton.addEventListener('click', function() {
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      });
    }
    
    console.log('Drawing functionality initialized');
  } catch (error) {
    console.error('Failed to initialize canvas:', error);
  }
});
</script>

    <script>
// Debug Helper
window.debugGame = function() {
  console.log('---- GAME STATE DEBUGGING ----');
  console.log('gameState exists:', typeof gameState !== 'undefined');
  
  if (typeof gameState !== 'undefined') {
    console.log('gameState.data exists:', typeof gameState.data !== 'undefined');
    console.log('Coins:', gameState.data?.coins);
    console.log('Day:', gameState.data?.day);
    console.log('Inventory items:', gameState.data?.inventory?.length);
    console.log('Shop displays:', gameState.data?.shopDisplays?.length);
  }
  
  console.log('UI exists:', typeof UI !== 'undefined');
  console.log('Canvas found:', !!document.querySelector('canvas'));
  
  console.log('---- DOM ELEMENTS ----');
  ['coinDisplay', 'dayDisplay', 'shopDisplays', 'inventoryItems', 'customerArea'].forEach(id => {
    console.log(`${id} exists:`, !!document.getElementById(id));
  });
  
  console.log('---- END DEBUG INFO ----');
};

// Run debug after page load
setTimeout(window.debugGame, 1000);
</script>
    
<script>
// Debug initialization sequence
(function() {
  console.log('Debug initialization helper loaded');
  
  // Report when UI is initialized
  const originalUIInit = UI.init;
  UI.init = function() {
    console.log('UI.init called');
    try {
      const result = originalUIInit.apply(this, arguments);
      console.log('UI.init completed, result:', result);
      return result;
    } catch (error) {
      console.error('UI.init failed:', error);
      return false;
    }
  };
  
  // Report when gameState is initialized
  if (window.gameState) {
    if (typeof gameState.init === 'function') {
      const originalGameStateInit = gameState.init;
      gameState.init = function() {
        console.log('gameState.init called');
        try {
          const result = originalGameStateInit.apply(this, arguments);
          console.log('gameState.init completed, result:', result);
          return result;
        } catch (error) {
          console.error('gameState.init failed:', error);
          return false;
        }
      };
    }
  } else {
    console.warn('gameState not found when setting up debug helpers');
  }
  
  // Check initialization status
  setTimeout(function() {
    console.group('Initialization Status (after 2s)');
    console.log('UI exists:', typeof UI !== 'undefined');
    console.log('UI initialized:', UI.state?.initialized === true);
    console.log('gameState exists:', typeof gameState !== 'undefined');
    console.log('gameState data:', gameState?.data ? Object.keys(gameState.data) : 'not available');
    console.groupEnd();
  }, 2000);
})();
</script>

    <script>
// Force UI initialization and hide loading screen
(function() {
  // Function to ensure UI is initialized
  function ensureUIInitialized() {
    console.log('Ensuring UI is initialized');
    
    if (typeof UI === 'undefined') {
      console.error('UI object not found - unable to proceed');
      showErrorMessage('UI system not loaded properly');
      return false;
    }
    
    try {
      // Initialize UI if needed
      if (!UI.state || !UI.state.initialized) {
        console.log('UI not initialized, initializing now');
        UI.init();
      }
      
      // Force UI to update
      if (typeof UI.updateAllUI === 'function') {
        UI.updateAllUI();
      }
      
      return true;
    } catch (error) {
      console.error('Error initializing UI:', error);
      showErrorMessage('Failed to initialize UI: ' + error.message);
      return false;
    }
  }
  
  // Function to hide loading screen
  function hideLoadingScreen() {
    console.log('Forcing loading screen to hide');
    
    const loadingScreen = document.getElementById('loadingScreen');
    if (loadingScreen) {
      loadingScreen.style.display = 'none';
      loadingScreen.classList.add('hidden');
    }
    
    const gameContainer = document.getElementById('gameContainer');
    if (gameContainer) {
      gameContainer.style.display = 'flex';
      gameContainer.classList.remove('hidden');
    }
  }
  
  // Function to show error message
  function showErrorMessage(message) {
    console.error(message);
    
    const errorScreen = document.getElementById('errorScreen');
    const errorMessage = document.getElementById('errorMessage');
    
    if (errorScreen && errorMessage) {
      errorMessage.textContent = message;
      errorScreen.style.display = 'flex';
      errorScreen.classList.remove('hidden');
    } else {
      alert('Game Error: ' + message);
    }
    
    // Hide loading screen in any case
    hideLoadingScreen();
  }
  
  // Wait a short time to ensure scripts are loaded
  setTimeout(function() {
    // Ensure gameState exists
    if (typeof gameState === 'undefined' || !gameState.data) {
      console.error('gameState object not found or invalid');
      showErrorMessage('Game state system not loaded properly');
      hideLoadingScreen();
      return;
    }
    
    // Initialize UI
    if (ensureUIInitialized()) {
      console.log('Game initialized successfully');
      hideLoadingScreen();
    } else {
      console.error('Game initialization failed');
      hideLoadingScreen();
    }
  }, 1000);
})();
</script>


    // Add at the end of your HTML, before the closing body tag
<script>
    // Debug product data
    document.addEventListener('DOMContentLoaded', function() {
        console.group('Product Data Debugging');
        console.log('ProductData object exists:', typeof window.ProductData !== 'undefined');
        
        if (window.ProductData && Array.isArray(window.ProductData.templates)) {
            console.log('Product templates found:', window.ProductData.templates.length);
            console.log('Templates:', window.ProductData.templates);
        } else {
            console.error('Product templates not found or not an array');
        }
        
        // Check gameState product methods
        console.log('gameState exists:', typeof window.gameState !== 'undefined');
        if (window.gameState) {
            console.log('getProductTemplate method exists:', typeof window.gameState.getProductTemplate === 'function');
            
            if (typeof window.gameState.getProductTemplate === 'function') {
                console.log('Sample product template:', window.gameState.getProductTemplate('mug'));
            }
        }
        
        // Check product selector element
        const productSelector = document.getElementById('productSelector');
        console.log('Product selector element found:', !!productSelector);
        if (productSelector) {
            console.log('Product selector options:', productSelector.options.length);
        }
        console.groupEnd();
    });
</script>
    
    
</body>
</html>
